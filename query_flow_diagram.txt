================================================================================
                    RAG CHATBOT - QUERY FLOW DIAGRAM
================================================================================

This diagram illustrates the complete flow of handling a user query from the
frontend through the backend and back, including all components and API calls.

================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                              FRONTEND (JavaScript)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User Types Query: "What is computer use?"                                  │
│           │                                                                  │
│           ▼                                                                  │
│  ┌──────────────────┐                                                       │
│  │  sendMessage()   │  Disable input, show loading indicator               │
│  └────────┬─────────┘                                                       │
│           │                                                                  │
│           ▼                                                                  │
│  POST /api/query                                                            │
│  {                                                                           │
│    "query": "What is computer use?",                                        │
│    "session_id": "abc123"                                                   │
│  }                                                                           │
└───────────┼──────────────────────────────────────────────────────────────────┘
            │
            │ HTTP Request
            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BACKEND - FastAPI (app.py)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  @app.post("/api/query")                                                    │
│  async def query_documents(request)                                         │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────┐                                               │
│  │ Get/Create Session ID   │                                               │
│  └───────────┬─────────────┘                                               │
│              │                                                               │
│              ▼                                                               │
│  rag_system.query(query, session_id)                                        │
└──────────────┼──────────────────────────────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      RAG SYSTEM (rag_system.py)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  query(query, session_id)                                                   │
│      │                                                                       │
│      ├──► ┌──────────────────────────┐                                     │
│      │    │ SessionManager           │                                     │
│      │    │ get_conversation_history()│ ─────┐                             │
│      │    └──────────────────────────┘       │                             │
│      │                                         │                             │
│      │    Returns: "Previous Q&A pairs"      │                             │
│      │◄───────────────────────────────────────┘                             │
│      │                                                                       │
│      ▼                                                                       │
│  ai_generator.generate_response(                                            │
│      query="Answer this: What is computer use?",                            │
│      conversation_history="...",                                            │
│      tools=[search_course_content],                                         │
│      tool_manager=tool_manager                                              │
│  )                                                                           │
└──────────┼──────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     AI GENERATOR (ai_generator.py)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────┐            │
│  │  FIRST CLAUDE API CALL                                      │            │
│  │  ─────────────────────                                      │            │
│  │  System: "You are an AI assistant... + conversation history"│            │
│  │  User: "Answer this: What is computer use?"                │            │
│  │  Tools: [search_course_content]                            │            │
│  │  Model: claude-sonnet-4-20250514                           │            │
│  │  Temperature: 0, Max tokens: 800                           │            │
│  └────────────────────┬───────────────────────────────────────┘            │
│                       │                                                      │
│                       ▼                                                      │
│           ┌───────────────────────┐                                         │
│           │  Claude's Decision    │                                         │
│           └───────┬───────────────┘                                         │
│                   │                                                          │
│        ┌──────────┴──────────┐                                             │
│        │                     │                                              │
│        ▼                     ▼                                              │
│  stop_reason:         stop_reason:                                          │
│  "end_turn"          "tool_use"                                             │
│        │                     │                                              │
│        │                     ▼                                              │
│        │         ┌─────────────────────────────┐                           │
│        │         │ _handle_tool_execution()    │                           │
│        │         └──────────┬──────────────────┘                           │
│        │                    │                                               │
│        │                    ▼                                               │
│        │         Extract tool call parameters:                              │
│        │         {                                                          │
│        │           "name": "search_course_content",                        │
│        │           "input": {                                              │
│        │             "query": "computer use",                              │
│        │             "course_name": null                                   │
│        │           }                                                        │
│        │         }                                                          │
│        │                    │                                               │
│        │                    ▼                                               │
│        │         tool_manager.execute_tool("search_course_content", ...)   │
└────────┼────────────────────┼───────────────────────────────────────────────┘
         │                    │
         │                    ▼
         │    ┌─────────────────────────────────────────────────────────────┐
         │    │         SEARCH TOOL (search_tools.py)                        │
         │    ├─────────────────────────────────────────────────────────────┤
         │    │                                                               │
         │    │  execute(query="computer use", course_name=None)            │
         │    │      │                                                        │
         │    │      ▼                                                        │
         │    │  vector_store.search(                                        │
         │    │      query="computer use",                                   │
         │    │      course_name=None,                                       │
         │    │      lesson_number=None                                      │
         │    │  )                                                            │
         │    └──────┼──────────────────────────────────────────────────────┘
         │           │
         │           ▼
         │    ┌─────────────────────────────────────────────────────────────┐
         │    │         VECTOR STORE (vector_store.py)                       │
         │    ├─────────────────────────────────────────────────────────────┤
         │    │                                                               │
         │    │  search(query, course_name, lesson_number)                  │
         │    │      │                                                        │
         │    │      ├─► IF course_name provided:                           │
         │    │      │   _resolve_course_name() → Semantic match in catalog │
         │    │      │                                                        │
         │    │      ├─► _build_filter() → Create ChromaDB filter           │
         │    │      │                                                        │
         │    │      ▼                                                        │
         │    │  ┌──────────────────────────────────────────┐               │
         │    │  │  ChromaDB Query (course_content)         │               │
         │    │  │  ────────────────────────────            │               │
         │    │  │  1. Embed query using SentenceTransformer│               │
         │    │  │     (all-MiniLM-L6-v2)                   │               │
         │    │  │                                           │               │
         │    │  │  2. Cosine similarity search             │               │
         │    │  │                                           │               │
         │    │  │  3. Apply filters (course/lesson)        │               │
         │    │  │                                           │               │
         │    │  │  4. Return top 5 chunks                  │               │
         │    │  └──────────────┬───────────────────────────┘               │
         │    │                 │                                             │
         │    │                 ▼                                             │
         │    │  Return SearchResults:                                       │
         │    │  {                                                            │
         │    │    documents: ["chunk1", "chunk2", ...],                    │
         │    │    metadata: [                                               │
         │    │      {course_title: "...", lesson_number: 0},               │
         │    │      ...                                                     │
         │    │    ],                                                        │
         │    │    distances: [0.23, 0.45, ...]                             │
         │    │  }                                                            │
         │    └─────────┬───────────────────────────────────────────────────┘
         │              │
         │              ▼ Return to Search Tool
         │    ┌─────────────────────────────────────────────────────────────┐
         │    │  _format_results(results)                                    │
         │    │      │                                                        │
         │    │      ▼                                                        │
         │    │  Formatted string:                                           │
         │    │  "[Course Title - Lesson 0]                                 │
         │    │   Computer use is a feature that allows Claude...           │
         │    │                                                               │
         │    │   [Course Title - Lesson 1]                                 │
         │    │   The model can take screenshots and..."                    │
         │    │                                                               │
         │    │  + Track sources for UI: ["Course - Lesson 0", ...]        │
         │    └─────────┬───────────────────────────────────────────────────┘
         │              │
         │              ▼ Return to AI Generator
         │    ┌─────────────────────────────────────────────────────────────┐
         │    │  Tool result received                                        │
         │    │                                                               │
         │    │  ┌────────────────────────────────────────────────┐         │
         │    │  │  SECOND CLAUDE API CALL                         │         │
         │    │  │  ──────────────────────                         │         │
         │    │  │  Messages:                                      │         │
         │    │  │    1. User: "Answer this: What is computer use?"│         │
         │    │  │    2. Assistant: [tool_use request]            │         │
         │    │  │    3. User: [tool_result with formatted chunks]│         │
         │    │  │                                                  │         │
         │    │  │  System: Same as before                         │         │
         │    │  │  NO tools this time                             │         │
         │    │  └────────────────┬───────────────────────────────┘         │
         │    │                   │                                           │
         │    │                   ▼                                           │
         │    │  Claude synthesizes final answer from chunks                │
         │    └─────────┬───────────────────────────────────────────────────┘
         │              │
         │              ▼
         │         "Computer use is a capability that allows Claude..."
         │              │
         ▼              │
    Direct answer       │
         │              │
         └──────┬───────┘
                │
                ▼ Return to RAG System
┌─────────────────────────────────────────────────────────────────────────────┐
│                      RAG SYSTEM (rag_system.py)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  response = "Computer use is a capability..."                              │
│      │                                                                       │
│      ├──► ┌──────────────────────────┐                                     │
│      │    │ ToolManager              │                                     │
│      │    │ get_last_sources()       │ Returns: ["Course - Lesson 0", ...]│
│      │◄───┤ reset_sources()          │                                     │
│      │    └──────────────────────────┘                                     │
│      │                                                                       │
│      ├──► ┌──────────────────────────┐                                     │
│      │    │ SessionManager           │                                     │
│      │    │ add_exchange()           │ Save Q&A to history                │
│      │    └──────────────────────────┘                                     │
│      │                                                                       │
│      ▼                                                                       │
│  return (response, sources)                                                 │
└──────────┼──────────────────────────────────────────────────────────────────┘
           │
           ▼ Return to FastAPI
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BACKEND - FastAPI (app.py)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Return JSON:                                                               │
│  {                                                                           │
│    "answer": "Computer use is a capability...",                            │
│    "sources": ["Course Title - Lesson 0", "Course Title - Lesson 1"],     │
│    "session_id": "abc123"                                                  │
│  }                                                                           │
└───────────┼──────────────────────────────────────────────────────────────────┘
            │
            │ HTTP Response
            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              FRONTEND (JavaScript)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Receive response data                                                      │
│      │                                                                       │
│      ▼                                                                       │
│  ┌─────────────────────┐                                                   │
│  │ Remove loading      │                                                   │
│  │ indicator           │                                                   │
│  └─────────┬───────────┘                                                   │
│            │                                                                 │
│            ▼                                                                 │
│  ┌─────────────────────┐                                                   │
│  │ Render answer       │  Convert markdown → HTML                         │
│  │ with marked.js      │  Display in chat                                 │
│  └─────────┬───────────┘                                                   │
│            │                                                                 │
│            ▼                                                                 │
│  ┌─────────────────────┐                                                   │
│  │ Display source      │  Show as clickable chips                         │
│  │ chips               │  "Course Title - Lesson 0"                       │
│  └─────────┬───────────┘                                                   │
│            │                                                                 │
│            ▼                                                                 │
│  ┌─────────────────────┐                                                   │
│  │ Update session_id   │  Save for next query                             │
│  └─────────┬───────────┘                                                   │
│            │                                                                 │
│            ▼                                                                 │
│  Enable input field for next question                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================
                              LEGEND
================================================================================

┌─┐ Component/Module
│ │ Process/Function
└─┘
 │  Sequential flow
 ▼

================================================================================
                           KEY FLOW SUMMARY
================================================================================

1. HTTP Requests/Responses:
   - 1 HTTP Request: Frontend → Backend
   - 1 HTTP Response: Backend → Frontend

2. Claude API Calls:
   - 2 API calls if search tool is used (tool request + final answer)
   - 1 API call if direct answer (no search needed)

3. Database Operations:
   - 1 ChromaDB query for semantic search (if tool is used)
   - Embedding computed using SentenceTransformer (all-MiniLM-L6-v2)

4. Session Management:
   - Conversation history retrieved at start
   - Q&A pair saved at end
   - Maintains last 2 exchanges for context

5. Component Interactions:
   - Frontend: User input → API call → Display response
   - FastAPI: Route request → RAG System → Return JSON
   - RAG System: Orchestrate AI + Tools + Session
   - AI Generator: Claude API + Tool calling loop
   - Search Tool: Execute search → Format results
   - Vector Store: ChromaDB semantic search
   - Session Manager: Track conversation history

================================================================================
                          FILE REFERENCES
================================================================================

Frontend:
- frontend/index.html       : Chat UI structure
- frontend/script.js:44-71  : sendMessage() function
- frontend/style.css        : Dark theme styling

Backend:
- backend/app.py:55-72      : /api/query endpoint
- backend/rag_system.py:102 : query() orchestration
- backend/ai_generator.py:42: generate_response() with tools
- backend/ai_generator.py:89: _handle_tool_execution() loop
- backend/search_tools.py:52: execute() search
- backend/vector_store.py:61: search() semantic retrieval
- backend/session_manager.py: Conversation history

Configuration:
- backend/config.py:25      : ChromaDB path (./chroma_db)
- backend/models.py         : Data models (Course, Lesson, CourseChunk)

================================================================================
                              END OF DIAGRAM
================================================================================
